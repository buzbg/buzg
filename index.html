<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Grouping Manager</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Circular', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #F7F5F2;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #0A2463 0%, #3E92CC 100%);
            color: white;
            padding: 40px 30px;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 8px;
            font-weight: 700;
        }

        .header p {
            font-size: 16px;
            opacity: 0.95;
        }

        .controls {
            background: #FFFFFF;
            padding: 24px 30px;
            border-bottom: 1px solid #E8E4DF;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #0A2463;
            color: white;
        }

        .btn-primary:hover {
            background: #081A4A;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(10, 36, 99, 0.3);
        }

        .btn-secondary {
            background: #3E92CC;
            color: white;
        }

        .btn-secondary:hover {
            background: #2E7AB8;
            box-shadow: 0 4px 12px rgba(62, 146, 204, 0.3);
        }

        .btn-success {
            background: #00C896;
            color: white;
        }

        .btn-success:hover {
            background: #00B386;
            box-shadow: 0 4px 12px rgba(0, 200, 150, 0.3);
        }

        input[type="file"] {
            display: none;
        }

        input[type="number"] {
            padding: 8px 12px;
            border: 2px solid #E8E4DF;
            border-radius: 8px;
            width: 80px;
            font-size: 14px;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: #3E92CC;
        }

        label {
            font-weight: 600;
            color: #2D3748;
        }

        .mode-toggle {
            display: flex;
            gap: 10px;
        }

        .mode-btn {
            padding: 8px 16px;
            border: 2px solid #3E92CC;
            background: white;
            color: #3E92CC;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .mode-btn.active {
            background: #3E92CC;
            color: white;
        }

        .mode-btn:hover {
            background: #E8F4FA;
        }

        .mode-btn.active:hover {
            background: #2E7AB8;
        }

        .content {
            padding: 30px;
        }

        .stats {
            background: #E8F4FA;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 24px;
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
            border: 1px solid #D0E9F5;
        }

        .stat-item {
            font-size: 14px;
            color: #4A5568;
        }

        .stat-item strong {
            color: #0A2463;
            font-size: 20px;
            font-weight: 700;
        }

        .groups-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        @media (min-width: 1400px) {
            .groups-container {
                grid-template-columns: repeat(5, 1fr);
            }
        }

        @media (min-width: 1200px) and (max-width: 1399px) {
            .groups-container {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (min-width: 900px) and (max-width: 1199px) {
            .groups-container {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .group {
            border: 2px solid #E8E4DF;
            border-radius: 12px;
            background: #fff;
            overflow: hidden;
            transition: all 0.2s;
        }

        .group:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.06);
        }

        .group.has-conflict {
            border-color: #E53E3E;
            box-shadow: 0 0 0 3px rgba(229, 62, 62, 0.1);
        }

        .group-header {
            background: #F7F5F2;
            padding: 8px 10px;
            font-weight: 600;
            border-bottom: 1px solid #E8E4DF;
            font-size: 13px;
        }

        .group.has-conflict .group-header {
            background: #FED7D7;
            color: #742A2A;
        }

        .group-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .conflict-badge {
            background: #E53E3E;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .conflict-details {
            font-size: 10px;
            color: #742A2A;
            margin-top: 4px;
            padding: 4px;
            background: #ffffff;
            border-radius: 4px;
            line-height: 1.3;
        }

        .conflict-details ul {
            margin: 2px 0 0 14px;
            padding: 0;
        }

        .dept-stats {
            font-size: 10px;
            color: #6c757d;
            margin-top: 2px;
        }

        .group-members {
            padding: 8px;
            min-height: 60px;
        }

        .employee-card {
            background: white;
            border: 1.5px solid #E8E4DF;
            border-radius: 8px;
            padding: 4px 6px;
            margin-bottom: 4px;
            cursor: move;
            transition: all 0.2s;
            font-size: 11px;
        }

        .employee-card:hover {
            border-color: #3E92CC;
            box-shadow: 0 2px 8px rgba(62, 146, 204, 0.15);
            transform: translateY(-1px);
        }

        .employee-card.dragging {
            opacity: 0.5;
        }

        .employee-name {
            font-weight: 600;
            color: #2D3748;
            margin-bottom: 2px;
            font-size: 12px;
            line-height: 1.2;
        }

        .employee-details {
            font-size: 10px;
            color: #718096;
            line-height: 1.3;
        }

        .manager-note {
            color: #E53E3E;
            font-style: italic;
        }

        .dept-badge {
            display: inline-block;
            padding: 1px 4px;
            border-radius: 2px;
            font-size: 9px;
            font-weight: 600;
            margin-top: 2px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        @media (max-width: 768px) {
            .groups-container {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>👥 Employee Grouping Manager</h1>
            <p>Upload employees, create balanced groups, avoid reporting conflicts</p>
        </div>

        <div class="controls">
            <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" />
            <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                📤 Upload Employee List
            </button>

            <div style="display: flex; align-items: center; gap: 10px;">
                <label>Group Size:</label>
                <input type="number" id="groupSize" value="12" min="1" max="50" />
            </div>

            <div style="display: flex; align-items: center; gap: 10px;">
                <label>Mode:</label>
                <div class="mode-toggle">
                    <button class="mode-btn active" data-mode="balanced">Balanced Mix</button>
                    <button class="mode-btn" data-mode="department">By Department</button>
                </div>
            </div>

            <button class="btn btn-secondary" onclick="createGroups()">
                🔄 Create Groups
            </button>

            <button class="btn btn-success" onclick="exportGroups()" id="exportBtn" style="display: none;">
                💾 Export to CSV
            </button>
        </div>

        <div class="content">
            <div id="stats" style="display: none;" class="stats"></div>
            <div id="groupsContainer"></div>
            <div id="emptyState" class="empty-state">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
                <h2>No Employees Loaded</h2>
                <p>Upload a CSV or Excel file with columns: Name, Employee ID, Department, Manager (or Manager ID)</p>
            </div>
        </div>
    </div>

    <script>
        let employees = [];
        let groups = [];
        let groupingMode = 'balanced';
        let employeeMap = {};

        const deptColors = {};
        const colorPalette = [
            '#E8F4FA', '#F0E7F8', '#E6F4EA', '#FFF4E6', '#FCE4EC',
            '#E0F2F1', '#F9FBE7', '#FFFDE7', '#FFE0B2', '#E1D4F4'
        ];

        function getDeptColor(dept) {
            if (!deptColors[dept]) {
                const index = Object.keys(deptColors).length % colorPalette.length;
                deptColors[dept] = colorPalette[index];
            }
            return deptColors[dept];
        }

        document.getElementById('fileInput').addEventListener('change', handleFileUpload);

        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                groupingMode = e.target.dataset.mode;
            });
        });

        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: (results) => {
                    employees = results.data.map((row, idx) => ({
                        id: `emp-${idx}`,
                        employeeId: row['Employee ID'] || row['employee_id'] || row['employeeId'] || row['EmployeeID'] || `EMP${idx}`,
                        name: row['Name'] || row['name'] || row['Employee Name'] || `Employee ${idx + 1}`,
                        department: row['Department'] || row['department'] || row['Dept'] || 'Unknown',
                        managerId: row['Manager'] || row['manager'] || row['Manager ID'] || row['manager_id'] || row['ManagerID'] || ''
                    }));
                    
                    employeeMap = {};
                    employees.forEach(emp => {
                        employeeMap[emp.employeeId.toString().trim().toLowerCase()] = emp;
                    });

                    employees.forEach(emp => {
                        if (emp.managerId) {
                            const managerKey = emp.managerId.toString().trim().toLowerCase();
                            const manager = employeeMap[managerKey];
                            emp.managerName = manager ? manager.name : emp.managerId;
                            emp.managerInFile = !!manager;
                        } else {
                            emp.managerName = '';
                            emp.managerInFile = false;
                        }
                    });
                    
                    groups = [];
                    updateStats();
                    renderGroups();
                }
            });
        }

        function checkReportingConflict(group) {
            const conflicts = [];
            const managers = new Map();
            const employeeIds = new Set();
            
            group.forEach(emp => {
                const empIdKey = emp.employeeId.toString().trim().toLowerCase();
                employeeIds.add(empIdKey);
                
                if (emp.managerId) {
                    const mgrIdKey = emp.managerId.toString().trim().toLowerCase();
                    if (!managers.has(mgrIdKey)) {
                        managers.set(mgrIdKey, []);
                    }
                    managers.get(mgrIdKey).push(emp);
                }
            });
            
            for (let empId of employeeIds) {
                if (managers.has(empId)) {
                    const manager = group.find(e => e.employeeId.toString().trim().toLowerCase() === empId);
                    const reports = managers.get(empId);
                    conflicts.push({
                        manager: manager,
                        reports: reports
                    });
                }
            }
            
            return conflicts;
        }

        function getDepartmentStats(group) {
            const deptCount = {};
            group.forEach(emp => {
                deptCount[emp.department] = (deptCount[emp.department] || 0) + 1;
            });
            return deptCount;
        }

        function createGroups() {
            if (employees.length === 0) {
                alert('Please upload an employee list first');
                return;
            }

            const size = parseInt(document.getElementById('groupSize').value);
            
            // Build manager-to-reports mapping
            const managerReports = new Map();
            employees.forEach(emp => {
                if (emp.managerId && emp.managerInFile) {
                    const mgrKey = emp.managerId.toString().trim().toLowerCase();
                    if (!managerReports.has(mgrKey)) {
                        managerReports.set(mgrKey, []);
                    }
                    managerReports.get(mgrKey).push(emp);
                }
            });

            let shuffled = [...employees];
            
            if (groupingMode === 'balanced') {
                // Balanced mode with conflict avoidance
                const byDept = {};
                employees.forEach(emp => {
                    if (!byDept[emp.department]) byDept[emp.department] = [];
                    byDept[emp.department].push(emp);
                });
                
                Object.keys(byDept).forEach(dept => {
                    byDept[dept].sort(() => Math.random() - 0.5);
                });
                
                shuffled = [];
                const depts = Object.keys(byDept);
                const maxLen = Math.max(...depts.map(d => byDept[d].length));
                
                for (let i = 0; i < maxLen; i++) {
                    depts.forEach(dept => {
                        if (byDept[dept][i]) shuffled.push(byDept[dept][i]);
                    });
                }
            } else {
                shuffled.sort(() => Math.random() - 0.5);
            }

            // Create initial groups
            groups = [];
            for (let i = 0; i < shuffled.length; i += size) {
                groups.push(shuffled.slice(i, i + size));
            }

            // Smart conflict resolution - try to swap employees to avoid conflicts
            let maxAttempts = 100;
            let attempts = 0;
            
            while (attempts < maxAttempts) {
                let foundConflict = false;
                
                for (let i = 0; i < groups.length; i++) {
                    const conflicts = checkReportingConflict(groups[i]);
                    
                    if (conflicts.length > 0) {
                        foundConflict = true;
                        
                        // Try to move one of the conflicting employees to another group
                        const conflict = conflicts[0];
                        const employeeToMove = conflict.reports[0]; // Move a direct report
                        
                        // Find a group without their manager
                        let swapped = false;
                        for (let j = 0; j < groups.length; j++) {
                            if (i === j) continue;
                            
                            const targetGroup = groups[j];
                            const hasManagerInTarget = targetGroup.some(e => 
                                e.employeeId.toString().trim().toLowerCase() === 
                                employeeToMove.managerId.toString().trim().toLowerCase()
                            );
                            
                            if (!hasManagerInTarget && targetGroup.length < size + 2) {
                                // Try to find someone to swap with (preferably same department)
                                let swapCandidate = targetGroup.find(e => 
                                    e.department === employeeToMove.department &&
                                    (!e.managerId || !employeeMap[e.managerId.toString().trim().toLowerCase()] ||
                                    !groups[i].some(emp => emp.employeeId.toString().trim().toLowerCase() === 
                                        e.managerId.toString().trim().toLowerCase()))
                                );
                                
                                if (!swapCandidate) {
                                    swapCandidate = targetGroup.find(e =>
                                        (!e.managerId || !employeeMap[e.managerId.toString().trim().toLowerCase()] ||
                                        !groups[i].some(emp => emp.employeeId.toString().trim().toLowerCase() === 
                                            e.managerId.toString().trim().toLowerCase()))
                                    );
                                }
                                
                                if (swapCandidate) {
                                    // Perform swap
                                    const empIdx = groups[i].findIndex(e => e.id === employeeToMove.id);
                                    const swapIdx = groups[j].findIndex(e => e.id === swapCandidate.id);
                                    
                                    groups[i][empIdx] = swapCandidate;
                                    groups[j][swapIdx] = employeeToMove;
                                    
                                    swapped = true;
                                    break;
                                }
                            }
                        }
                        
                        if (swapped) break;
                    }
                }
                
                if (!foundConflict) break;
                attempts++;
            }

            updateStats();
            renderGroups();
            document.getElementById('exportBtn').style.display = 'inline-flex';
        }

        function updateStats() {
            const statsEl = document.getElementById('stats');
            const emptyEl = document.getElementById('emptyState');
            
            if (employees.length === 0) {
                statsEl.style.display = 'none';
                emptyEl.style.display = 'block';
                return;
            }

            emptyEl.style.display = 'none';
            statsEl.style.display = 'flex';

            const conflictCount = groups.filter(g => checkReportingConflict(g).length > 0).length;
            const totalGroups = groups.length;

            statsEl.innerHTML = `
                <div class="stat-item">
                    <div><strong>${employees.length}</strong></div>
                    <div>Total Employees</div>
                </div>
                <div class="stat-item">
                    <div><strong>${totalGroups}</strong></div>
                    <div>Groups Created</div>
                </div>
                <div class="stat-item">
                    <div><strong style="color: ${conflictCount > 0 ? '#E53E3E' : '#00C896'}">${conflictCount}</strong></div>
                    <div>Reporting Conflicts</div>
                </div>
            `;
        }

        function renderGroups() {
            const container = document.getElementById('groupsContainer');
            
            if (groups.length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = groups.map((group, groupIdx) => {
                const conflicts = checkReportingConflict(group);
                const hasConflict = conflicts.length > 0;
                const deptStats = getDepartmentStats(group);
                const deptStatsText = Object.entries(deptStats)
                    .map(([dept, count]) => `${dept}: ${count}`)
                    .join(' | ');

                let conflictDetailsHtml = '';
                if (hasConflict) {
                    conflictDetailsHtml = '<div class="conflict-details"><strong>⚠️ Conflicts:</strong><ul>';
                    conflicts.forEach(conflict => {
                        conflictDetailsHtml += `<li><strong>${conflict.manager.name}</strong> + ${conflict.reports.map(r => r.name).join(', ')}</li>`;
                    });
                    conflictDetailsHtml += '</ul></div>';
                }

                return `
                    <div class="group ${hasConflict ? 'has-conflict' : ''}" data-group="${groupIdx}">
                        <div class="group-header">
                            <div class="group-title">
                                <div>
                                    <div>Group ${groupIdx + 1} (${group.length})</div>
                                    <div class="dept-stats">${deptStatsText}</div>
                                </div>
                                ${hasConflict ? '<span class="conflict-badge">⚠️</span>' : ''}
                            </div>
                            ${conflictDetailsHtml}
                        </div>
                        <div class="group-members" data-group="${groupIdx}">
                            ${group.map((emp, empIdx) => {
                                const managerDisplay = emp.managerId 
                                    ? (emp.managerInFile 
                                        ? emp.managerName 
                                        : `${emp.managerName} <span class="manager-note">(not in file)</span>`)
                                    : 'None';
                                
                                return `
                                    <div class="employee-card" 
                                         draggable="true" 
                                         data-group="${groupIdx}" 
                                         data-index="${empIdx}"
                                         data-employee='${JSON.stringify(emp)}'>
                                        <div class="employee-name">${emp.name}</div>
                                        <div class="employee-details">
                                            <div>${emp.employeeId} • ${managerDisplay}</div>
                                        </div>
                                        <span class="dept-badge" style="background: ${getDeptColor(emp.department)}">${emp.department}</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');

            attachDragHandlers();
        }

        function attachDragHandlers() {
            const cards = document.querySelectorAll('.employee-card');
            const members = document.querySelectorAll('.group-members');

            cards.forEach(card => {
                card.addEventListener('dragstart', (e) => {
                    card.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/plain', '');
                });

                card.addEventListener('dragend', () => {
                    card.classList.remove('dragging');
                });
            });

            members.forEach(container => {
                container.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    const afterElement = getDragAfterElement(container, e.clientY);
                    const dragging = document.querySelector('.dragging');
                    
                    if (afterElement == null) {
                        container.appendChild(dragging);
                    } else {
                        container.insertBefore(dragging, afterElement);
                    }
                });

                container.addEventListener('drop', (e) => {
                    e.preventDefault();
                    updateGroupsFromDOM();
                    updateStats();
                    renderGroups();
                });
            });
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.employee-card:not(.dragging)')];

            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;

                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        function updateGroupsFromDOM() {
            const groupContainers = document.querySelectorAll('.group-members');
            groups = [];

            groupContainers.forEach(container => {
                const group = [];
                const cards = container.querySelectorAll('.employee-card');
                
                cards.forEach(card => {
                    const empData = JSON.parse(card.dataset.employee);
                    group.push(empData);
                });

                if (group.length > 0) {
                    groups.push(group);
                }
            });
        }

        function exportGroups() {
            if (groups.length === 0) {
                alert('No groups to export');
                return;
            }

            const csvData = [];
            groups.forEach((group, idx) => {
                const conflicts = checkReportingConflict(group);
                const hasConflict = conflicts.length > 0;
                
                group.forEach(emp => {
                    csvData.push({
                        'Group Number': idx + 1,
                        'Employee ID': emp.employeeId,
                        'Name': emp.name,
                        'Department': emp.department,
                        'Manager ID': emp.managerId,
                        'Manager Name': emp.managerName,
                        'Manager In File': emp.managerInFile ? 'Yes' : 'No',
                        'Has Conflict': hasConflict ? 'YES' : 'NO'
                    });
                });
            });

            const csv = Papa.unparse(csvData);
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `employee-groups-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
