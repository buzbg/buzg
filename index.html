<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Grouping Manager</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .controls {
            background: #f8f9fa;
            padding: 20px 30px;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        input[type="file"] {
            display: none;
        }

        input[type="number"] {
            padding: 8px 12px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            width: 80px;
            font-size: 14px;
        }

        label {
            font-weight: 600;
            color: #495057;
        }

        .mode-toggle {
            display: flex;
            gap: 10px;
        }

        .mode-btn {
            padding: 8px 16px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .mode-btn.active {
            background: #667eea;
            color: white;
        }

        .content {
            padding: 30px;
        }

        .stats {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }

        .stat-item {
            font-size: 14px;
            color: #495057;
        }

        .stat-item strong {
            color: #212529;
            font-size: 18px;
        }

        .groups-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .group {
            border: 2px solid #dee2e6;
            border-radius: 8px;
            background: #fff;
            overflow: hidden;
        }

        .group.has-conflict {
            border-color: #dc3545;
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1);
        }

        .group-header {
            background: #f8f9fa;
            padding: 12px 15px;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
        }

        .group.has-conflict .group-header {
            background: #f8d7da;
            color: #721c24;
        }

        .group-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .conflict-badge {
            background: #dc3545;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .conflict-details {
            font-size: 11px;
            color: #721c24;
            margin-top: 6px;
            padding: 6px;
            background: #ffffff;
            border-radius: 4px;
            line-height: 1.4;
        }

        .conflict-details ul {
            margin: 4px 0 0 18px;
            padding: 0;
        }

        .dept-stats {
            font-size: 11px;
            color: #6c757d;
            margin-top: 4px;
        }

        .group-members {
            padding: 10px;
            min-height: 80px;
        }

        .employee-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 4px;
            padding: 6px 8px;
            margin-bottom: 6px;
            cursor: move;
            transition: all 0.2s;
            font-size: 12px;
        }

        .employee-card:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }

        .employee-card.dragging {
            opacity: 0.5;
        }

        .employee-name {
            font-weight: 600;
            color: #212529;
            margin-bottom: 3px;
            font-size: 13px;
        }

        .employee-details {
            font-size: 11px;
            color: #6c757d;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .manager-note {
            color: #dc3545;
            font-style: italic;
        }

        .dept-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
            margin-top: 3px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .drop-zone {
            border: 2px dashed #dee2e6;
            border-radius: 6px;
            padding: 20px;
            text-align: center;
            color: #6c757d;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .drop-zone.drag-over {
            border-color: #667eea;
            background: #f0f3ff;
        }

        @media (max-width: 768px) {
            .groups-container {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>👥 Employee Grouping Manager</h1>
            <p>Upload employees, create balanced groups, avoid reporting conflicts</p>
        </div>

        <div class="controls">
            <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" />
            <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                📤 Upload Employee List
            </button>

            <div style="display: flex; align-items: center; gap: 10px;">
                <label>Group Size:</label>
                <input type="number" id="groupSize" value="12" min="1" max="50" />
            </div>

            <div style="display: flex; align-items: center; gap: 10px;">
                <label>Mode:</label>
                <div class="mode-toggle">
                    <button class="mode-btn active" data-mode="balanced">Balanced Mix</button>
                    <button class="mode-btn" data-mode="department">By Department</button>
                </div>
            </div>

            <button class="btn btn-secondary" onclick="createGroups()">
                🔄 Create Groups
            </button>

            <button class="btn btn-success" onclick="exportGroups()" id="exportBtn" style="display: none;">
                💾 Export to CSV
            </button>
        </div>

        <div class="content">
            <div id="stats" style="display: none;" class="stats"></div>
            <div id="groupsContainer"></div>
            <div id="emptyState" class="empty-state">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
                <h2>No Employees Loaded</h2>
                <p>Upload a CSV or Excel file with columns: Name, Employee ID, Department, Manager (or Manager ID)</p>
            </div>
        </div>
    </div>

    <script>
        let employees = [];
        let groups = [];
        let groupingMode = 'balanced';
        let employeeMap = {}; // Maps employee ID to employee object

        // Department color mapping
        const deptColors = {};
        const colorPalette = [
            '#e3f2fd', '#f3e5f5', '#e8f5e9', '#fff3e0', '#fce4ec',
            '#e0f2f1', '#f1f8e9', '#fff9c4', '#ffe0b2', '#d1c4e9'
        ];

        function getDeptColor(dept) {
            if (!deptColors[dept]) {
                const index = Object.keys(deptColors).length % colorPalette.length;
                deptColors[dept] = colorPalette[index];
            }
            return deptColors[dept];
        }

        document.getElementById('fileInput').addEventListener('change', handleFileUpload);

        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                groupingMode = e.target.dataset.mode;
            });
        });

        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: (results) => {
                    employees = results.data.map((row, idx) => ({
                        id: `emp-${idx}`,
                        employeeId: row['Employee ID'] || row['employee_id'] || row['employeeId'] || row['EmployeeID'] || `EMP${idx}`,
                        name: row['Name'] || row['name'] || row['Employee Name'] || `Employee ${idx + 1}`,
                        department: row['Department'] || row['department'] || row['Dept'] || 'Unknown',
                        managerId: row['Manager'] || row['manager'] || row['Manager ID'] || row['manager_id'] || row['ManagerID'] || ''
                    }));
                    
                    // Build employee map for quick lookup
                    employeeMap = {};
                    employees.forEach(emp => {
                        employeeMap[emp.employeeId.toString().trim().toLowerCase()] = emp;
                    });

                    // Add manager names to each employee
                    employees.forEach(emp => {
                        if (emp.managerId) {
                            const managerKey = emp.managerId.toString().trim().toLowerCase();
                            const manager = employeeMap[managerKey];
                            emp.managerName = manager ? manager.name : emp.managerId;
                            emp.managerInFile = !!manager;
                        } else {
                            emp.managerName = '';
                            emp.managerInFile = false;
                        }
                    });
                    
                    groups = [];
                    updateStats();
                    renderGroups();
                }
            });
        }

        function checkReportingConflict(group) {
            const conflicts = [];
            const managers = new Map(); // Map of manager ID to employees who report to them
            const employeeIds = new Set();
            
            group.forEach(emp => {
                const empIdKey = emp.employeeId.toString().trim().toLowerCase();
                employeeIds.add(empIdKey);
                
                if (emp.managerId) {
                    const mgrIdKey = emp.managerId.toString().trim().toLowerCase();
                    if (!managers.has(mgrIdKey)) {
                        managers.set(mgrIdKey, []);
                    }
                    managers.get(mgrIdKey).push(emp);
                }
            });
            
            // Check if any employee ID matches a manager in the same group
            for (let empId of employeeIds) {
                if (managers.has(empId)) {
                    const manager = group.find(e => e.employeeId.toString().trim().toLowerCase() === empId);
                    const reports = managers.get(empId);
                    conflicts.push({
                        manager: manager,
                        reports: reports
                    });
                }
            }
            
            return conflicts;
        }

        function getDepartmentStats(group) {
            const deptCount = {};
            group.forEach(emp => {
                deptCount[emp.department] = (deptCount[emp.department] || 0) + 1;
            });
            return deptCount;
        }

        function createGroups() {
            if (employees.length === 0) {
                alert('Please upload an employee list first');
                return;
            }

            const size = parseInt(document.getElementById('groupSize').value);
            let shuffled = [...employees];
            
            if (groupingMode === 'balanced') {
                const byDept = {};
                employees.forEach(emp => {
                    if (!byDept[emp.department]) byDept[emp.department] = [];
                    byDept[emp.department].push(emp);
                });
                
                Object.keys(byDept).forEach(dept => {
                    byDept[dept].sort(() => Math.random() - 0.5);
                });
                
                shuffled = [];
                const depts = Object.keys(byDept);
                const maxLen = Math.max(...depts.map(d => byDept[d].length));
                
                for (let i = 0; i < maxLen; i++) {
                    depts.forEach(dept => {
                        if (byDept[dept][i]) shuffled.push(byDept[dept][i]);
                    });
                }
            } else {
                shuffled.sort(() => Math.random() - 0.5);
            }

            groups = [];
            for (let i = 0; i < shuffled.length; i += size) {
                groups.push(shuffled.slice(i, i + size));
            }

            updateStats();
            renderGroups();
            document.getElementById('exportBtn').style.display = 'inline-flex';
        }

        function updateStats() {
            const statsEl = document.getElementById('stats');
            const emptyEl = document.getElementById('emptyState');
            
            if (employees.length === 0) {
                statsEl.style.display = 'none';
                emptyEl.style.display = 'block';
                return;
            }

            emptyEl.style.display = 'none';
            statsEl.style.display = 'flex';

            const conflictCount = groups.filter(g => checkReportingConflict(g).length > 0).length;
            const totalGroups = groups.length;

            statsEl.innerHTML = `
                <div class="stat-item">
                    <div><strong>${employees.length}</strong></div>
                    <div>Total Employees</div>
                </div>
                <div class="stat-item">
                    <div><strong>${totalGroups}</strong></div>
                    <div>Groups Created</div>
                </div>
                <div class="stat-item">
                    <div><strong style="color: ${conflictCount > 0 ? '#dc3545' : '#28a745'}">${conflictCount}</strong></div>
                    <div>Reporting Conflicts</div>
                </div>
            `;
        }

        function renderGroups() {
            const container = document.getElementById('groupsContainer');
            
            if (groups.length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = groups.map((group, groupIdx) => {
                const conflicts = checkReportingConflict(group);
                const hasConflict = conflicts.length > 0;
                const deptStats = getDepartmentStats(group);
                const deptStatsText = Object.entries(deptStats)
                    .map(([dept, count]) => `${dept}: ${count}`)
                    .join(' | ');

                let conflictDetailsHtml = '';
                if (hasConflict) {
                    conflictDetailsHtml = '<div class="conflict-details"><strong>⚠️ Reporting Conflicts:</strong><ul>';
                    conflicts.forEach(conflict => {
                        conflictDetailsHtml += `<li><strong>${conflict.manager.name}</strong> is grouped with their direct report(s): ${conflict.reports.map(r => r.name).join(', ')}</li>`;
                    });
                    conflictDetailsHtml += '</ul></div>';
                }

                return `
                    <div class="group ${hasConflict ? 'has-conflict' : ''}" data-group="${groupIdx}">
                        <div class="group-header">
                            <div class="group-title">
                                <div>
                                    <div>Group ${groupIdx + 1} (${group.length} members)</div>
                                    <div class="dept-stats">${deptStatsText}</div>
                                </div>
                                ${hasConflict ? '<span class="conflict-badge">⚠️ Conflict</span>' : ''}
                            </div>
                            ${conflictDetailsHtml}
                        </div>
                        <div class="group-members" data-group="${groupIdx}">
                            ${group.map((emp, empIdx) => {
                                const managerDisplay = emp.managerId 
                                    ? (emp.managerInFile 
                                        ? emp.managerName 
                                        : `${emp.managerName} <span class="manager-note">(manager not in file)</span>`)
                                    : 'None';
                                
                                return `
                                    <div class="employee-card" 
                                         draggable="true" 
                                         data-group="${groupIdx}" 
                                         data-index="${empIdx}"
                                         data-employee='${JSON.stringify(emp)}'>
                                        <div class="employee-name">${emp.name}</div>
                                        <div class="employee-details">
                                            <div>ID: ${emp.employeeId}</div>
                                            <div>Manager: ${managerDisplay}</div>
                                        </div>
                                        <span class="dept-badge" style="background: ${getDeptColor(emp.department)}">${emp.department}</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');

            attachDragHandlers();
        }

        function attachDragHandlers() {
            const cards = document.querySelectorAll('.employee-card');
            const members = document.querySelectorAll('.group-members');

            cards.forEach(card => {
                card.addEventListener('dragstart', (e) => {
                    card.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/plain', '');
                });

                card.addEventListener('dragend', () => {
                    card.classList.remove('dragging');
                });
            });

            members.forEach(container => {
                container.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    const afterElement = getDragAfterElement(container, e.clientY);
                    const dragging = document.querySelector('.dragging');
                    
                    if (afterElement == null) {
                        container.appendChild(dragging);
                    } else {
                        container.insertBefore(dragging, afterElement);
                    }
                });

                container.addEventListener('drop', (e) => {
                    e.preventDefault();
                    updateGroupsFromDOM();
                    updateStats();
                    renderGroups();
                });
            });
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.employee-card:not(.dragging)')];

            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;

                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        function updateGroupsFromDOM() {
            const groupContainers = document.querySelectorAll('.group-members');
            groups = [];

            groupContainers.forEach(container => {
                const group = [];
                const cards = container.querySelectorAll('.employee-card');
                
                cards.forEach(card => {
                    const empData = JSON.parse(card.dataset.employee);
                    group.push(empData);
                });

                if (group.length > 0) {
                    groups.push(group);
                }
            });
        }

        function exportGroups() {
            if (groups.length === 0) {
                alert('No groups to export');
                return;
            }

            const csvData = [];
            groups.forEach((group, idx) => {
                const conflicts = checkReportingConflict(group);
                const hasConflict = conflicts.length > 0;
                
                group.forEach(emp => {
                    csvData.push({
                        'Group Number': idx + 1,
                        'Employee ID': emp.employeeId,
                        'Name': emp.name,
                        'Department': emp.department,
                        'Manager ID': emp.managerId,
                        'Manager Name': emp.managerName,
                        'Manager In File': emp.managerInFile ? 'Yes' : 'No',
                        'Has Conflict': hasConflict ? 'YES' : 'NO'
                    });
                });
            });

            const csv = Papa.unparse(csvData);
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `employee-groups-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
