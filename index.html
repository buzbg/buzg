<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Employee Grouping Manager</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Circular',-apple-system,BlinkMacSystemFont,'Segoe UI',Arial,sans-serif;background:#FAFAFA;min-height:100vh;padding:20px}
    .container{max-width:1800px;margin:0 auto;background:#fff;border-radius:16px;box-shadow:0 2px 16px rgba(0,0,0,.08);overflow:hidden}
    .header{background:linear-gradient(135deg,#000 0%,#1a1a1a 100%);color:#fff;padding:40px 30px}
    .header h1{font-size:32px;margin-bottom:8px;font-weight:700}
    .header p{font-size:16px;opacity:.9;color:#E0E0E0}
    .controls{background:#fff;padding:24px 30px;border-bottom:1px solid #E0E0E0;display:grid;grid-template-columns:repeat(12,1fr);gap:16px;align-items:center}
    .span-3{grid-column:span 3}.span-6{grid-column:span 6}.span-12{grid-column:span 12}
    .btn{padding:12px 24px;border:none;border-radius:8px;cursor:pointer;font-size:14px;font-weight:600;display:inline-flex;align-items:center;gap:8px;transition:.2s}
    .btn-primary{background:#000;color:#fff}.btn-primary:hover{background:#333;transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,.2)}
    .btn-secondary{background:#E91E63;color:#fff}.btn-secondary:hover{background:#C2185B;box-shadow:0 4px 12px rgba(233,30,99,.3)}
    .btn-success{background:#00C896;color:#fff}.btn-success:hover{background:#00B386;box-shadow:0 4px 12px rgba(0,200,150,.3)}
    .btn-small{padding:6px 12px;font-size:11px;border-radius:6px}
    input[type=file]{display:none}
    input[type=number],select{padding:8px 12px;border:2px solid #E0E0E0;border-radius:8px;font-size:14px}
    input[type=number]{width:80px}input[type=number]:focus,select:focus{outline:none;border-color:#E91E63}
    label{font-weight:600;color:#1a1a1a;font-size:12px}
    .mode-toggle{display:flex;gap:10px;flex-wrap:wrap}
    .mode-btn{padding:8px 16px;border:2px solid #E91E63;background:#fff;color:#E91E63;border-radius:8px;cursor:pointer;font-size:14px;font-weight:600;transition:.2s}
    .mode-btn.active{background:#E91E63;color:#fff}.mode-btn:hover{background:#FCE4EC}.mode-btn.active:hover{background:#C2185B}
    .content{padding:30px}
    .stats{background:#F5F5F5;padding:20px;border-radius:12px;margin-bottom:24px;display:flex;gap:30px;flex-wrap:wrap;border:1px solid #E0E0E0}
    .stat-item{font-size:14px;color:#424242}.stat-item strong{color:#000;font-size:20px;font-weight:700}
    .groups-wrapper{display:grid;grid-template-columns:repeat(3,1fr);gap:20px}
    @media(max-width:1200px){.groups-wrapper{grid-template-columns:repeat(2,1fr)}}@media(max-width:768px){.groups-wrapper{grid-template-columns:1fr}}
    .group-column{display:flex;flex-direction:column;gap:15px}
    .add-group-zone{border:2px dashed #E0E0E0;border-radius:12px;padding:30px 20px;text-align:center;color:#757575;background:#FAFAFA;cursor:pointer;transition:.2s;min-height:120px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px}
    .add-group-zone:hover{border-color:#E91E63;background:#FCE4EC;color:#880E4F}.add-group-zone.drag-over{border-color:#E91E63;background:#FCE4EC;color:#880E4F;border-width:3px}
    .group{border:2px solid #E0E0E0;border-radius:12px;background:#fff;overflow:hidden;transition:.2s}
    .group:hover{box-shadow:0 4px 12px rgba(0,0,0,.08)}.group.has-conflict{border-color:#E91E63;box-shadow:0 0 0 3px rgba(233,30,99,.1)}
    .group-header{background:#F5F5F5;padding:10px 12px;font-weight:600;border-bottom:1px solid #E0E0E0;font-size:13px}
    .group.has-conflict .group-header{background:#FCE4EC;color:#880E4F}
    .group-title{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;gap:8px}
    .conflict-badge{background:#E91E63;color:#fff;padding:3px 8px;border-radius:4px;font-size:10px;display:inline-flex;align-items:center;gap:4px}
    .conflict-details{font-size:10px;color:#880E4F;margin-top:6px;padding:6px;background:#fff;border-radius:4px;line-height:1.4}
    .conflict-details ul{margin:4px 0 0 14px;padding:0}.conflict-actions{margin-top:6px;display:flex;gap:6px;flex-wrap:wrap}
    .move-employee-btn{background:#E91E63;color:#fff;border:none;padding:4px 8px;border-radius:4px;font-size:10px;cursor:pointer;transition:.2s}
    .move-employee-btn:hover{background:#C2185B}
    .dept-stats{font-size:10px;color:#757575;margin-top:2px}
    .slot-stats{font-size:10px;color:#424242;margin-top:2px}
    .group-members{padding:10px;min-height:60px}
    .employee-card{background:#fff;border:1.5px solid #E0E0E0;border-radius:8px;padding:6px 8px;margin-bottom:6px;cursor:move;transition:.2s;font-size:11px}
    .employee-card:hover{border-color:#E91E63;box-shadow:0 2px 8px rgba(233,30,99,.15);transform:translateY(-1px)}
    .employee-card.dragging{opacity:.5}
    .employee-card.conflict{border-color:#E91E63!important;box-shadow:0 0 0 2px rgba(233,30,99,.25)}
    .employee-name{font-weight:600;color:#1a1a1a;margin-bottom:3px;font-size:12px;line-height:1.2}
    .employee-details{font-size:10px;color:#616161;line-height:1.4}
    .manager-label{color:#424242;font-weight:500}.manager-note{color:#757575;font-style:italic}
    .dept-badge{display:inline-block;padding:2px 6px;border-radius:4px;font-size:9px;font-weight:600;margin-top:3px;border:1px solid rgba(0,0,0,.1)}
    .time-badge{display:inline-block;padding:2px 6px;border-radius:4px;font-size:9px;font-weight:600;margin-top:3px;border:1px dashed rgba(0,0,0,.2)}
    .time-badge.active{background:#FFE3EE;border-color:#E91E63;box-shadow:0 0 0 1px rgba(233,30,99,.25) inset}
    .slot-pill{display:inline-block;padding:2px 6px;border-radius:12px;border:1px solid rgba(0,0,0,.15);font-size:9px;margin-right:4px;margin-top:3px}
    .slot-pill.match{background:#FFE3EE;border-color:#E91E63}
    .empty-state{text-align:center;padding:60px 20px;color:#757575}
    .empty-state svg{width:64px;height:64px;margin-bottom:20px;opacity:.3}
    .card{border:1px solid #E0E0E0;border-radius:12px;padding:12px}
    .muted{color:#757575;font-size:12px}
    .btn-ghost{background:transparent;border:1px solid #E0E0E0;color:#424242}
    .btn-ghost:hover{border-color:#C2185B;color:#C2185B}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üë• Employee Grouping Manager</h1>
      <p>Upload employees, create balanced groups, avoid reporting & time conflicts</p>
    </div>

    <div class="controls">
      <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" />
      <div class="span-3">
        <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">üì§ Upload Employee List</button>
      </div>
      <div class="span-3">
        <label>Group Size</label><br />
        <input type="number" id="groupSize" value="12" min="1" max="50" />
      </div>
      <div class="span-6">
        <label>Mode</label>
        <div class="mode-toggle">
          <button class="mode-btn active" data-mode="balanced">Balanced Mix</button>
          <button class="mode-btn" data-mode="department">By Department</button>
          <button class="mode-btn" data-mode="time">By Time Preferences</button>
        </div>
      </div>
      <div class="span-12 card">
        <div style="display:grid;grid-template-columns:repeat(12,1fr);gap:10px;">
          <div class="span-3">
            <label>Reporting Lines Priority</label>
            <select id="prioReporting">
              <option value="P0" selected>P0 ‚Äî No conflicts allowed</option>
              <option value="P1">P1 ‚Äî Strong preference</option>
              <option value="P2">P2 ‚Äî Nice to have</option>
              <option value="OFF">Off</option>
            </select>
          </div>
          <div class="span-3">
            <label>Department Mix Priority</label>
            <select id="prioDepartment">
              <option value="P0">P0 ‚Äî No mono‚Äëdepartment</option>
              <option value="P1" selected>P1 ‚Äî Strong preference</option>
              <option value="P2">P2 ‚Äî Nice to have</option>
              <option value="OFF">Off</option>
            </select>
          </div>
          <div class="span-3">
            <label>Time Preferences Priority</label>
            <select id="prioTime">
              <option value="P0">P0 ‚Äî Must share a slot</option>
              <option value="P1" selected>P1 ‚Äî Strong preference</option>
              <option value="P2">P2 ‚Äî Nice to have</option>
              <option value="OFF">Off</option>
            </select>
          </div>
        </div>
        <div class="muted" style="margin-top:8px;">Time slot column accepted headers: <strong>Time Preferences</strong>, <strong>Timeslots</strong>, or <strong>Preferred Times</strong>. Values can be comma or semicolon separated (e.g., "8-10am; 10-12pm"). Supported slots: 8-10am, 10-12pm, 12-2pm, 2-4pm, 4-6pm.</div>
      </div>
      <div class="span-6">
        <button class="btn btn-secondary" onclick="createGroups()">üîÑ Create Groups</button>
      </div>
      <div class="span-6" style="text-align:right;">
        <button class="btn btn-success" onclick="exportGroups()" id="exportBtn" style="display:none;">üíæ Export to CSV</button>
      </div>
    </div>

    <div class="content">
      <div id="stats" style="display:none;" class="stats"></div>
      <div id="groupsContainer" class="groups-wrapper"></div>
      <div id="emptyState" class="empty-state">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
        <h2>No Employees Loaded</h2>
        <p>Upload a CSV with columns: Name, Employee ID, Department, Manager (or Manager ID), and Time Preferences (optional)</p>
      </div>
    </div>
  </div>

  <script>
    let employees=[]; let groups=[]; let groupingMode='balanced'; let employeeMap={}; let actionsBound=false;
    const ALL_SLOTS=["8-10am","10-12pm","12-2pm","2-4pm","4-6pm"];
    const deptColors={}; const colorPalette=['#E8F5E9','#FCE4EC','#E3F2FD','#FFF3E0','#F3E5F5','#E0F2F1','#FFF9C4','#FFEBEE','#E8EAF6','#F1F8E9'];
    function getDeptColor(dept){ if(!deptColors[dept]){const i=Object.keys(deptColors).length%colorPalette.length; deptColors[dept]=colorPalette[i];} return deptColors[dept]; }
    function norm(x){return (x||'').toString().trim().toLowerCase();}

    document.getElementById('fileInput').addEventListener('change',handleFileUpload);
    document.querySelectorAll('.mode-btn').forEach(btn=>btn.addEventListener('click',e=>{document.querySelectorAll('.mode-btn').forEach(b=>b.classList.remove('active')); e.target.classList.add('active'); groupingMode=e.target.dataset.mode;}));

    function parseSlots(raw){ if(!raw) return []; const tokens=raw.split(/[;,]/).map(s=>s.trim()); const out=new Set(); tokens.forEach(function(t){const x=t.replace(/\s+/g,'').toLowerCase(); if(/^(8-10|8‚Äì10)am$/.test(x)) out.add('8-10am'); else if(/^(10-12|10‚Äì12)pm?$/.test(x)) out.add('10-12pm'); else if(/^(12-2|12‚Äì2)pm?$/.test(x)) out.add('12-2pm'); else if(/^(2-4|2‚Äì4)pm$/.test(x)) out.add('2-4pm'); else if(/^(4-6|4‚Äì6)pm$/.test(x)) out.add('4-6pm'); else if(ALL_SLOTS.indexOf(t)>-1) out.add(t);}); return Array.from(out); }
    function commonSlots(members){ if(!members.length) return []; var inter=new Set(members[0].timePrefs||[]); for(var i=1;i<members.length;i++){ inter=new Set(Array.from(inter).filter(function(x){return (members[i].timePrefs||[]).indexOf(x)>-1;})); if(!inter.size) break; } return Array.from(inter); }
    function bestSlotByPopularity(members){ var counts={}; members.forEach(function(m){ (m.timePrefs||[]).forEach(function(s){ counts[s]=(counts[s]||0)+1; }); }); var best=null,c=-1; Object.keys(counts).forEach(function(k){ if(counts[k]>c){c=counts[k]; best=k;} }); return {slot:best,count:c}; }
    function timeAlignment(group){ var inter=commonSlots(group); if(inter.length>0) return {conflicts:[],common:inter,best:inter[0]}; var best=bestSlotByPopularity(group).slot; var conflicts=group.filter(function(m){return (m.timePrefs||[]).indexOf(best)===-1;}); return {conflicts:conflicts,common:[],best:best}; }

    function handleFileUpload(e){ var file=e.target.files[0]; if(!file) return; Papa.parse(file,{header:true,skipEmptyLines:true,complete:function(results){ employees=results.data.map(function(row,idx){ var mgr=row['Manager']||row['manager']||row['Manager ID']||row['manager_id']||row['ManagerID']||''; var timeRaw=row['Time Preferences']||row['Timeslots']||row['Preferred Times']||''; return { id:'emp-'+idx, employeeId:row['Employee ID']||row['employee_id']||row['employeeId']||row['EmployeeID']||('EMP'+idx), name:row['Name']||row['name']||row['Employee Name']||('Employee '+(idx+1)), department:row['Department']||row['department']||row['Dept']||'Unknown', managerId:mgr, timePrefs:parseSlots(timeRaw) }; }); employeeMap={}; employees.forEach(function(emp){ employeeMap[norm(emp.employeeId)]=emp; }); employees.forEach(function(emp){ if(emp.managerId){ var m=employeeMap[norm(emp.managerId)]; emp.managerName=m?m.name:emp.managerId; emp.managerInFile=!!m; } else { emp.managerName=''; emp.managerInFile=false; } }); groups=[]; updateStats(); renderGroups(); }}); }

    function checkReportingConflicts(group){ var conflicts=[]; var managers={}; var ids={}; group.forEach(function(emp){ ids[norm(emp.employeeId)]=true; if(emp.managerId){ var k=norm(emp.managerId); if(!managers[k]) managers[k]=[]; managers[k].push(emp); } }); Object.keys(ids).forEach(function(id){ if(managers[id]){ var manager=group.find(function(e){return norm(e.employeeId)===id;}); var reports=managers[id]; conflicts.push({manager:manager,reports:reports}); } }); return conflicts; }
    function getDepartmentStats(group){ var stats={}; group.forEach(function(emp){ stats[emp.department]=(stats[emp.department]||0)+1; }); return stats; }

    function isManager(emp){ return employees.some(function(e){return norm(e.managerId)===norm(emp.employeeId);}); }
    function constraintRank(emp,prioReporting){ var timeLen=(emp.timePrefs||[]).length||5; var rarity=employees.filter(function(e){return e.department===emp.department;}).length; var mgrBoost=(prioReporting==='P0' && isManager(emp))? -5:0; return mgrBoost + timeLen + Math.log(1+rarity); }

    function groupScore(group,opts){ var prioReporting=opts.prioReporting, prioDepartment=opts.prioDepartment, prioTime=opts.prioTime; var score=0; var rep=checkReportingConflicts(group); if(prioReporting==='P0' && rep.length>0) return Infinity; if(prioReporting==='P1') score+=1000*rep.length; if(prioReporting==='P2') score+=100*rep.length; var t=timeAlignment(group); if(prioTime==='P0' && t.common.length===0) return Infinity; if(prioTime==='P1') score+=(t.conflicts||[]).length; if(prioTime==='P2') score+=0.5*(t.conflicts||[]).length; var ds=getDepartmentStats(group); var vals=Object.values(ds); var maxDept=Math.max.apply(null,vals.length?vals:[0]); if(prioDepartment==='P0' && maxDept===group.length && group.length>1) return Infinity; var denom=Math.max(1,Object.keys(ds).length); var ideal=Math.ceil(group.length/denom); var imbalance=maxDept - ideal; if(prioDepartment==='P1') score+=Math.max(0,imbalance); if(prioDepartment==='P2') score+=0.5*Math.max(0,imbalance); return score; }

    function createGroups(){ if(!employees.length){ alert('Please upload an employee list first'); return; } var size=parseInt(document.getElementById('groupSize').value,10); var prioReporting=document.getElementById('prioReporting').value; var prioDepartment=document.getElementById('prioDepartment').value; var prioTime=document.getElementById('prioTime').value; var opts={prioReporting:prioReporting,prioDepartment:prioDepartment,prioTime:prioTime}; var nGroups=Math.ceil(employees.length/size)||1; groups=Array.from({length:nGroups},function(){return [];}); var pool=employees.slice(); pool.sort(function(a,b){return constraintRank(a,prioReporting)-constraintRank(b,prioReporting);}); if(groupingMode==='time'){ var buckets={}; pool.forEach(function(emp){ var k=(emp.timePrefs&&emp.timePrefs[0])?emp.timePrefs[0]:'NO_SLOT'; if(!buckets[k]) buckets[k]=[]; buckets[k].push(emp); }); var keys=Object.keys(buckets); var maxLen=Math.max.apply(null,keys.map(function(k){return buckets[k].length;})); var inter=[]; for(var i=0;i<maxLen;i++){ keys.forEach(function(k){ if(buckets[k][i]) inter.push(buckets[k][i]); }); } pool=inter; }
      pool.forEach(function(emp){ var bestIdx=-1,bestDelta=Infinity; for(var gi=0;gi<groups.length;gi++){ if(groups[gi].length>=size) continue; var before=groupScore(groups[gi],opts); var after=groupScore(groups[gi].concat([emp]),opts); var delta=after-before; if(after!==Infinity && delta<bestDelta){ bestDelta=delta; bestIdx=gi; } } if(bestIdx===-1){ groups.push([emp]); } else { groups[bestIdx].push(emp); } });
      var MAX_ITERS=120; for(var it=0; it<MAX_ITERS; it++){ var improved=false; for(var i2=0;i2<groups.length;i2++){ for(var j=i2+1;j<groups.length;j++){ var Gi=groups[i2], Gj=groups[j]; for(var a=0;a<Gi.length;a++){ for(var b=0;b<Gj.length;b++){ var before=groupScore(Gi,opts)+groupScore(Gj,opts); var ei=Gi[a], ej=Gj[b]; Gi[a]=ej; Gj[b]=ei; var after=groupScore(Gi,opts)+groupScore(Gj,opts); if(after+1e-6<before){ improved=true; } else { Gi[a]=ei; Gj[b]=ej; } } } } } if(!improved) break; }
      updateStats(); renderGroups(); document.getElementById('exportBtn').style.display='inline-flex'; }

    function updateStats(){ var statsEl=document.getElementById('stats'); var emptyEl=document.getElementById('emptyState'); if(!employees.length){ statsEl.style.display='none'; emptyEl.style.display='block'; return; } emptyEl.style.display='none'; statsEl.style.display='flex'; var repGroups=groups.filter(function(g){return checkReportingConflicts(g).length>0;}).length; var timeGroups=groups.filter(function(g){return timeAlignment(g).common.length===0;}).length; var total=groups.length; statsEl.innerHTML='\
      <div class="stat-item"><div><strong>'+employees.length+'</strong></div><div>Total Employees</div></div>\
      <div class="stat-item"><div><strong>'+total+'</strong></div><div>Groups Created</div></div>\
      <div class="stat-item"><div><strong style="color:'+(repGroups>0?'#E91E63':'#00C896')+'">'+repGroups+'</strong></div><div>Reporting Conflicts</div></div>\
      <div class="stat-item"><div><strong style="color:'+(timeGroups>0?'#E91E63':'#00C896')+'">'+timeGroups+'</strong></div><div>Time Slot Misalignment*</div></div>\
      <div class="stat-item"><div class="muted">*No fully shared slot across the group</div></div>';
    }

    function renderGroups(){ var container=document.getElementById('groupsContainer'); if(!groups.length){ container.innerHTML=''; return; }
      var columns=[[],[],[]]; groups.forEach(function(g,idx){ columns[idx%3].push({group:g,idx:idx}); });
      var html='';
      columns.forEach(function(column,colIdx){
        var inner='';
        column.forEach(function(item){
          var group=item.group, groupIdx=item.idx;
          var rep=checkReportingConflicts(group); var t=timeAlignment(group);
          var hasConflict = rep.length>0 || (t.common.length===0);
          var ds=getDepartmentStats(group);
          var deptText=Object.keys(ds).map(function(k){return k+': '+ds[k];}).join(' | ');
          var conflictIds={}; rep.forEach(function(c){ c.reports.forEach(function(r){ conflictIds[r.id]=true; }); }); if(t.common.length===0 && t.conflicts){ t.conflicts.forEach(function(r){ conflictIds[r.id]=true; }); }

          var details='';
          if(rep.length>0 || t.common.length===0){
            details += '<div class="conflict-details"><strong>‚ö†Ô∏è Conflicts:</strong><ul>';
            rep.forEach(function(c){ details += '<li><strong>'+(c.manager && c.manager.name?c.manager.name:'Manager')+'</strong> with '+c.reports.map(function(r){return r.name;}).join(', ')+'</li>'; });
            if(t.common.length===0){ details += '<li><strong>Time</strong>: No shared slot. '+(t.best?('Suggested slot: <em>'+t.best+'</em>'):'No popular slot')+'</li>'; }
            details += '</ul><div class="conflict-actions">';
            rep.forEach(function(c){ c.reports.forEach(function(r){ details += '<button class="move-employee-btn action-move" data-group="'+groupIdx+'" data-emp="'+r.id+'">Move '+r.name+'</button><button class="move-employee-btn action-move-new" data-group="'+groupIdx+'" data-emp="'+r.id+'">Move '+r.name+' to new group</button>'; }); });
            if(t.common.length===0 && t.conflicts){ t.conflicts.forEach(function(r){ details += '<button class="move-employee-btn action-move" data-group="'+groupIdx+'" data-emp="'+r.id+'">Move '+r.name+'</button><button class="move-employee-btn action-move-new" data-group="'+groupIdx+'" data-emp="'+r.id+'">Move '+r.name+' to new group</button>'; }); }
            details += '</div></div>';
          }

          var groupSlot = (t.common.length>0 ? t.common[0] : (t.best || '‚Äî'));
          var card = '';
          card += '<div class="group '+(hasConflict?'has-conflict':'')+'" data-group="'+groupIdx+'">';
          card +=   '<div class="group-header">';
          card +=     '<div class="group-title">';
          card +=       '<div>';
          card +=         '<div>Group '+(groupIdx+1)+' ('+group.length+')</div>';
          card +=         '<div class="dept-stats">'+deptText+'</div>';
          card +=         '<div class="slot-stats">Group Slot: <span class="time-badge '+(groupSlot!=='‚Äî'?'active':'')+'">'+groupSlot+'</span></div>';
          card +=       '</div>';
          card +=       '<div class="group-actions">'+(hasConflict?'<span class="conflict-badge">‚ö†Ô∏è Conflict</span>':'')+' <button class="btn btn-ghost btn-small action-delete" data-group="'+groupIdx+'">üóë Delete group</button></div>';
          card +=     '</div>';
          card +=     details;
          card +=   '</div>';
          card +=   '<div class="group-members" data-group="'+groupIdx+'">';

          group.forEach(function(emp,empIdx){
            var mgr='';
            if(!emp.managerId) mgr='<span class="manager-note">Manager and their manager are not in this cohort</span>';
            else if(emp.managerInFile) mgr='<span class="manager-label">Manager:</span> '+emp.managerName;
            else mgr='<span class="manager-label">Manager:</span> '+emp.managerName+' <span class="manager-note">(not in cohort)</span>';
            var prefs=(emp.timePrefs&&emp.timePrefs.length)?emp.timePrefs:[];
            var timeHtml = (prefs.length? prefs.map(function(s){return '<span class="slot-pill '+(s===groupSlot?'match':'')+'">'+s+'</span>';}).join('') : '‚Äî');
            var conflictClass = conflictIds[emp.id]?'conflict':'';
            var dataAttr = JSON.stringify(emp).replace(/'/g,"&#39;").replace(/"/g,'&quot;');
            card += '<div class="employee-card '+conflictClass+'" draggable="true" data-group="'+groupIdx+'" data-index="'+empIdx+'" data-employee='+dataAttr+'>';
            card +=   '<div class="employee-name">'+emp.name+'</div>';
            card +=   '<div class="employee-details">';
            card +=     '<div>ID: '+emp.employeeId+'</div>';
            card +=     '<div>'+mgr+'</div>';
            card +=     '<div>Time Prefs: '+timeHtml+'</div>';
            card +=   '</div>';
            card +=   '<span class="dept-badge" style="background:'+getDeptColor(emp.department)+'">'+emp.department+'</span>';
            card += '</div>';
          });

          card +=   '</div>'; // members
          card += '</div>'; // group
          inner += card;
        });

        var addZone = '';
        if(colIdx===2){
          addZone = '<div class="add-group-zone" id="addGroupZone"><div class="add-group-icon">‚ûï</div><div class="add-group-text">Drag employee here to create new group</div></div>';
        }
        html += '<div class="group-column">'+ inner + addZone +'</div>';
      });

      container.innerHTML = html;
      attachDragHandlers(); attachAddGroupZoneHandlers(); attachActionHandlers();
    }

    function attachActionHandlers(){ if(actionsBound) return; actionsBound=true; var container=document.getElementById('groupsContainer'); container.addEventListener('click', function(e){ var moveBtn=e.target.closest('.action-move'); var moveNewBtn=e.target.closest('.action-move-new'); var delBtn=e.target.closest('.action-delete'); if(moveBtn){ var gi=parseInt(moveBtn.dataset.group,10); var id=moveBtn.dataset.emp; moveEmployeeToResolveConflict(gi,id); } else if(moveNewBtn){ var gi2=parseInt(moveNewBtn.dataset.group,10); var id2=moveNewBtn.dataset.emp; moveEmployeeToNewGroup(gi2,id2); } else if(delBtn){ var gi3=parseInt(delBtn.dataset.group,10); deleteGroup(gi3); } }); }

    function attachDragHandlers(){ var cards=document.querySelectorAll('.employee-card'); var members=document.querySelectorAll('.group-members'); cards.forEach(function(card){ card.addEventListener('dragstart',function(e){ card.classList.add('dragging'); e.dataTransfer.effectAllowed='move'; e.dataTransfer.setData('text/plain',''); }); card.addEventListener('dragend',function(){ card.classList.remove('dragging'); }); }); members.forEach(function(container){ container.addEventListener('dragover',function(e){ e.preventDefault(); var after=getDragAfterElement(container,e.clientY); var dragging=document.querySelector('.dragging'); if(!dragging) return; if(after==null) container.appendChild(dragging); else container.insertBefore(dragging,after); }); container.addEventListener('drop',function(e){ e.preventDefault(); updateGroupsFromDOM(); updateStats(); renderGroups(); }); }); }

    function attachAddGroupZoneHandlers(){ var add=document.getElementById('addGroupZone'); if(!add) return; add.addEventListener('dragover',function(e){ e.preventDefault(); add.classList.add('drag-over'); }); add.addEventListener('dragleave',function(){ add.classList.remove('drag-over'); }); add.addEventListener('drop',function(e){ e.preventDefault(); add.classList.remove('drag-over'); var dragging=document.querySelector('.dragging'); if(!dragging) return; var emp=JSON.parse(dragging.dataset.employee.replace(/&quot;/g,'"').replace(/&#39;/g,"'")); var gi=parseInt(dragging.dataset.group,10); var src=groups[gi]; var idx=src.findIndex(function(x){return x.id===emp.id;}); if(idx!==-1) src.splice(idx,1); groups.push([emp]); updateStats(); renderGroups(); }); add.addEventListener('click',function(){ groups.push([]); updateStats(); renderGroups(); }); }

    function getDragAfterElement(container,y){ var els=Array.prototype.slice.call(container.querySelectorAll('.employee-card:not(.dragging)')); return els.reduce(function(closest,child){ var box=child.getBoundingClientRect(); var offset=y-box.top-box.height/2; if(offset<0 && offset>closest.offset){ return {offset:offset,element:child}; } else { return closest; } },{offset:-Infinity}).element; }

    function updateGroupsFromDOM(){ var containers=document.querySelectorAll('.group-members'); groups=[]; containers.forEach(function(c){ var g=[]; c.querySelectorAll('.employee-card').forEach(function(card){ var data=card.dataset.employee.replace(/&quot;/g,'"').replace(/&#39;/g,"'" ); g.push(JSON.parse(data)); }); if(g.length>0) groups.push(g); }); }

    function moveEmployeeToResolveConflict(groupIdx,employeeId){ var source=groups[groupIdx]; var empIdx=source.findIndex(function(e){return e.id===employeeId;}); if(empIdx===-1) return; var employee=source[empIdx]; var prioTime=document.getElementById('prioTime').value; for(var i=0;i<groups.length;i++){ if(i===groupIdx) continue; var target=groups[i]; var hasMgr=target.some(function(e){return norm(e.employeeId)===norm(employee.managerId);}); var t=timeAlignment(target.concat([employee])); var timeOk=(prioTime!=='P0') || (t.common.length>0); if(!hasMgr && timeOk){ source.splice(empIdx,1); target.push(employee); updateStats(); renderGroups(); return; } } alert('No suitable group found that satisfies constraints. Try moving to a new group.'); }

    function moveEmployeeToNewGroup(groupIdx,employeeId){ var source=groups[groupIdx]; var idx=source.findIndex(function(e){return e.id===employeeId;}); if(idx===-1) return; var emp=source.splice(idx,1)[0]; groups.push([emp]); updateStats(); renderGroups(); }
    function deleteGroup(groupIdx){ if(groupIdx<0||groupIdx>=groups.length) return; var toMove=groups[groupIdx]; if(toMove.length>0 && !confirm('Delete this group and redistribute its members?')) return; groups.splice(groupIdx,1); toMove.forEach(function(emp){ if(groups.length===0) groups.push([emp]); else { var best=0,size=Infinity; for(var i=0;i<groups.length;i++){ if(groups[i].length<size){ size=groups[i].length; best=i; } } groups[best].push(emp);} }); updateStats(); renderGroups(); }

    function exportGroups(){ if(!groups.length){ alert('No groups to export'); return; } var rows=[]; groups.forEach(function(g,idx){ var rep=checkReportingConflicts(g); var hasRep=rep.length>0; var t=timeAlignment(g); var hasTime=t.common.length===0; var groupSlot=(t.common[0]||t.best||''); g.forEach(function(emp){ rows.push({ 'Group Number':idx+1,'Employee ID':emp.employeeId,'Name':emp.name,'Department':emp.department,'Manager ID':emp.managerId,'Manager Name':emp.managerName,'Manager In File':emp.managerInFile?'Yes':'No','Time Preferences':(emp.timePrefs||[]).join('; '),'Group Slot (derived)':groupSlot,'Has Reporting Conflict':hasRep?'YES':'NO','Has Time Conflict':hasTime?'YES':'NO' }); }); }); var csv=Papa.unparse(rows); var blob=new Blob([csv],{type:'text/csv'}); var url=URL.createObjectURL(blob); var a=document.createElement('a'); a.href=url; a.download='employee-groups-'+(new Date().toISOString().split('T')[0])+'.csv'; a.click(); URL.revokeObjectURL(url); }
  </script>
</body>
</html>
